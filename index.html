<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Speaking Check App</title>
    <!-- Tailwind CSSã®èª­ã¿è¾¼ã¿ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Tailwindã®è¨­å®šï¼š Interãƒ•ã‚©ãƒ³ãƒˆã¨ã‚«ã‚¹ã‚¿ãƒ ã‚«ãƒ©ãƒ¼ã‚’ä½¿ç”¨
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-blue': '#4F46E5', // Indigo
                        'secondary-yellow': '#FBBF24', // Amber
                        'success-green': '#10B981', // Emerald
                        'danger-red': '#EF4444', // Red
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                },
            }
        }
    </script>
    <style>
        /* Interãƒ•ã‚©ãƒ³ãƒˆã®èª­ã¿è¾¼ã¿ */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');

        /* ãƒã‚¤ã‚¯ãƒœã‚¿ãƒ³ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        .microphone-btn {
            transition: all 0.2s ease-in-out;
            cursor: pointer;
        }
        .microphone-btn:active {
            transform: scale(0.95);
        }
        
        /* éŒ²éŸ³ä¸­ã®ãƒ‘ãƒ«ã‚¹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        .recording-pulse {
            animation: pulse-red 1.5s infinite;
        }
        
        @keyframes pulse-red {
            0%, 100% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
            }
            50% {
                box-shadow: 0 0 0 30px rgba(239, 68, 68, 0);
            }
        }
    </style>
</head>
<body class="bg-gray-50 flex items-center justify-center min-h-screen p-4 font-sans">

    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒŠ -->
    <div class="w-full max-w-lg bg-white rounded-3xl shadow-2xl p-6 md:p-10 border-4 border-primary-blue">
        
        <!-- ã‚¿ã‚¤ãƒˆãƒ« -->
        <h1 class="text-3xl md:text-4xl font-bold text-center text-primary-blue mb-6">
            <span role="img" aria-label="check mark">âœ…</span>
            Speaking Check
            <span role="img" aria-label="check mark">âœ…</span>
        </h1>

        <!-- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¨ãƒªã‚¢ -->
        <div id="status-display" class="bg-primary-blue/10 p-4 rounded-xl mb-8 text-center text-lg font-semibold text-primary-blue h-20 flex items-center justify-center">
            <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’ä¿ƒã™ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºã™ã‚‹ -->
            <p id="status-text">ãƒã‚¤ã‚¯ãƒœã‚¿ãƒ³ã‚’ã‚¿ãƒƒãƒ—ã—ã¦è‹±èªã‚’è©±ã—ã¦ãã ã•ã„ã€‚</p>
        </div>

        <!-- èªè­˜ã•ã‚ŒãŸãƒ†ã‚­ã‚¹ãƒˆè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
        <div class="bg-white border-2 border-secondary-yellow p-4 rounded-xl shadow-inner min-h-[100px] mb-8">
            <h2 class="text-xl font-bold text-gray-700 mb-2">What You Saidï¼ˆã‚ãªãŸãŒè¨€ã£ãŸã“ã¨ï¼‰ï¼š</h2>
            <p id="result-text" class="text-2xl text-gray-800 font-extrabold break-words">---</p>
        </div>
        
        <!-- æ¡ç‚¹çµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
        <div id="score-area" class="bg-gray-100 p-4 rounded-xl border border-gray-300 mb-8 hidden">
            <h2 class="text-xl font-bold text-primary-blue mb-3">Your Score</h2>
            
            <div class="flex items-center space-x-4 mb-3">
                <span id="score-text" class="text-5xl font-extrabold text-gray-500">--</span>
                <span class="text-3xl font-bold text-gray-500">/ 100</span>
            </div>

            <!-- æ—¥æœ¬èªè¨³ -->
            <h3 class="text-lg font-bold text-gray-700 mb-1 mt-4">æ—¥æœ¬èªè¨³:</h3>
            <p id="retranslation-text" class="text-gray-800 font-semibold mb-3">...</p> 

            <h3 class="text-lg font-bold text-gray-700 mb-1">Feedback:</h3>
            <p id="feedback-text" class="text-gray-600 italic">... waiting for check ...</p>
        </div>

        <!-- ãƒã‚¤ã‚¯ãƒœã‚¿ãƒ³ã‚³ãƒ³ãƒ†ãƒŠ -->
        <div class="flex flex-col items-center justify-center">
            <button id="microphone-button" class="microphone-btn 
                w-32 h-32 rounded-full 
                bg-primary-blue text-white 
                shadow-xl hover:shadow-2xl 
                flex items-center justify-center 
                focus:outline-none" 
                aria-label="Start/Stop Recording">
                
                <!-- ãƒã‚¤ã‚¯ã‚¢ã‚¤ã‚³ãƒ³ (Lucide iconé¢¨ã®SVG) -->
                <svg id="mic-icon" xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-12 h-12">
                    <path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3z"></path>
                    <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                    <line x1="12" y1="19" x2="12" y2="22"></line>
                </svg>
            </button>
            <!-- éŒ²éŸ³æŒ‡ç¤ºãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
            <p id="mic-instruction" class="mt-4 text-gray-600 font-medium">Tap and speak!</p>
        </div>
        
        <!-- æ³¨æ„æ›¸ã (iframeã®åˆ¶ç´„ã«é–¢ã™ã‚‹å…·ä½“çš„ãªæŒ‡ç¤ºã‚’ä¿®æ­£) -->
        <div id="warning-box" class="mt-8 p-3 text-sm rounded-lg bg-danger-red/10 border border-danger-red text-danger-red">
            <p class="font-bold mb-1">âš ï¸ å‹•ä½œã—ãªã„å ´åˆã®ã”æ³¨æ„</p>
            <p id="warning-text">
                ãƒã‚¤ã‚¯ãŒä½¿ç”¨ã§ããªã„å ´åˆã¯<strong class="font-extrabold">åˆ©ç”¨è¨±å¯è¨­å®š</strong>ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚
            </p>
        </div>

    </div>

    <script>
        // ç’°å¢ƒãŒAPIã‚­ãƒ¼ã‚’è‡ªå‹•æŒ¿å…¥ã™ã‚‹ãŸã‚ã®ãƒ•ãƒƒã‚¯ã¨ã—ã¦ã€ç©ºã®ã‚­ãƒ¼ã‚’å®šç¾©ã—ã¾ã™ã€‚
        const apiKey = ""; 
        const modelName = "gemini-2.5-flash-preview-09-2025";
        
        // DOMè¦ç´ ã®å–å¾—
        const statusText = document.getElementById('status-text');
        const resultText = document.getElementById('result-text');
        const micButton = document.getElementById('microphone-button');
        const micIcon = document.getElementById('mic-icon');
        const micInstruction = document.getElementById('mic-instruction');
        const warningBox = document.getElementById('warning-box');
        const warningText = document.getElementById('warning-text');
        
        // æ¡ç‚¹æ©Ÿèƒ½ç”¨ã®DOMè¦ç´ 
        const scoreArea = document.getElementById('score-area');
        const scoreText = document.getElementById('score-text');
        const feedbackText = document.getElementById('feedback-text');
        const retranslationText = document.getElementById('retranslation-text'); 

        // Web Speech APIã®äº’æ›æ€§ã‚’ç¢ºèª
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        
        let recognition = null;
        let isRecording = false;

        // JSONã‚¹ã‚­ãƒ¼ãƒå®šç¾© (LLMç”¨)
        const responseSchema = {
            type: "OBJECT",
            properties: {
                "score": { 
                    "type": "NUMBER",
                    "description": "A score from 1 to 100 based on grammatical correctness, fluency, and appropriateness for elementary school level. Prioritize encouragement." 
                },
                "feedback_en": { 
                    "type": "STRING",
                    "description": "A very simple, encouraging, and actionable feedback message in English for an elementary student (e.g., 'Great job! Try to say 'hello' next time.'). Max 15 words." 
                },
                "feedback_jp": { 
                    "type": "STRING",
                    "description": "å°å­¦ç”Ÿå‘ã‘ã®ç°¡å˜ãªæ—¥æœ¬èªãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ï¼ˆä¾‹ï¼šã™ã”ãä¸Šæ‰‹ï¼æ¬¡ã¯ã€Œã“ã‚“ã«ã¡ã¯ã€ã¨è¨€ã£ã¦ã¿ã¦ã­ã€‚ï¼‰ã€‚" 
                },
                "retranslation_jp": { 
                    "type": "STRING",
                    "description": "The best Japanese translation of the spoken English transcript, suitable for an elementary student."
                }
            },
            "required": ["score", "feedback_en", "feedback_jp", "retranslation_jp"],
            "propertyOrdering": ["score", "feedback_en", "feedback_jp", "retranslation_jp"]
        };

        /**
         * LLMã‚’ä½¿ç”¨ã—ã¦è‹±èªã‚’æ¡ç‚¹ã—ã€ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’å–å¾—ã™ã‚‹é–¢æ•°
         * @param {string} userTranscript - ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè©±ã—ãŸè‹±èªã®ãƒ†ã‚­ã‚¹ãƒˆ
         * @returns {Promise<object>} ã‚¹ã‚³ã‚¢ã€ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã€æ—¥æœ¬èªè¨³ã‚’å«ã‚€ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
         */
        async function checkEnglishAndScore(userTranscript) {
            scoreArea.classList.remove('hidden');
            scoreText.textContent = '...';
            scoreText.classList.remove('text-success-green', 'text-secondary-yellow', 'text-danger-red');
            scoreText.classList.add('text-gray-500');
            retranslationText.textContent = '...';
            feedbackText.textContent = 'Checking your English... (AI is thinking)';

            const systemPrompt = "You are a friendly and encouraging English teacher for elementary school students. Your task is to evaluate a single English sentence provided by the student. Provide a score from 1 to 100 based on correctness, clarity, and fluency. The scoring should be generous and focused on positive reinforcement. You must also provide the best Japanese translation of the spoken sentence, suitable for a child. Always return the response in the specified JSON format.";
            const userQuery = `Please score, give feedback, and provide a Japanese translation for the following English sentence spoken by a child: "${userTranscript}"`;
            
            // é‡è¦ãªä¿®æ­£: APIã‚­ãƒ¼ã®è‡ªå‹•æŒ¿å…¥ã‚’æœ‰åŠ¹ã«ã™ã‚‹ãŸã‚ã€?key=${apiKey} ã‚’å«ã‚ã‚‹
            // ç’°å¢ƒãŒã“ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã§èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ã‚’æŒ¿å…¥ã™ã‚‹ã“ã¨ã‚’æœŸå¾…ã—ã¾ã™ã€‚
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: responseSchema
                }
            };

            const maxRetries = 3;
            let lastError = null;

            for (let attempt = 0; attempt < maxRetries; attempt++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        // HTTPã‚¨ãƒ©ãƒ¼ã®å ´åˆã€ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’å«ã‚ã¦ã‚¨ãƒ©ãƒ¼ã‚’æŠ•ã’ã‚‹
                        const errorBody = await response.text();
                        // 403ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã€ãƒ­ã‚°ã«è©³ç´°ã‚’å«ã‚ã‚‹
                        console.error(`Attempt ${attempt + 1} received a bad response status: ${response.status}. Full error body:`, errorBody.substring(0, 500) + '...');
                        throw new Error(`HTTP error! status: ${response.status} (${response.statusText}). Error details: ${errorBody.substring(0, 80)}...`);
                    }

                    const result = await response.json();
                    const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    
                    if (!jsonText) {
                        // JSONãƒ†ã‚­ã‚¹ãƒˆãŒç©ºã®å ´åˆã€å®Œå…¨ãªçµæœã‚’ãƒ­ã‚°ã«å«ã‚ã‚‹
                        console.error("Received unexpected or empty API response structure. Full result:", result);
                        throw new Error("API response was missing expected JSON content.");
                    }

                    const parsedJson = JSON.parse(jsonText);
                    return parsedJson;

                } catch (error) {
                    lastError = error;
                    // Exponential backoff
                    if (attempt < maxRetries - 1) {
                        await new Promise(resolve => setTimeout(resolve, Math.pow(2, attempt) * 1000));
                    }
                }
            }
            // å…¨ã¦ã®ãƒªãƒˆãƒ©ã‚¤ãŒå¤±æ•—ã—ãŸå ´åˆ
            throw new Error(`Failed to get score after ${maxRetries} attempts. Last error: ${lastError.message}`);
        }

        /**
         * æ¡ç‚¹çµæœã‚’UIã«è¡¨ç¤ºã™ã‚‹é–¢æ•°
         * @param {object} scoreData - ã‚¹ã‚³ã‚¢ãƒ‡ãƒ¼ã‚¿ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
         */
        function displayScore(scoreData) {
            const score = scoreData.score;
            const feedback = `${scoreData.feedback_en} (${scoreData.feedback_jp})`;
            const retranslation = scoreData.retranslation_jp; 

            scoreText.textContent = score;
            feedbackText.textContent = feedback;
            retranslationText.textContent = retranslation; 

            // ã‚¹ã‚³ã‚¢ã«å¿œã˜ã¦è‰²ã‚’å¤‰æ›´
            scoreText.classList.remove('text-gray-500', 'text-success-green', 'text-secondary-yellow', 'text-danger-red');
            if (score >= 90) {
                scoreText.classList.add('text-success-green');
            } else if (score >= 70) {
                scoreText.classList.add('text-secondary-yellow');
            } else {
                scoreText.classList.add('text-danger-red');
            }
        }

        /**
         * éŸ³å£°èªè­˜æ©Ÿèƒ½ã®åˆæœŸåŒ–ã¨ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
         */
        function initRecognition() {
            // åˆæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¨­å®š
            statusText.textContent = 'ãƒã‚¤ã‚¯ãƒœã‚¿ãƒ³ã‚’ã‚¿ãƒƒãƒ—ã—ã¦è‹±èªã‚’è©±ã—ã¦ãã ã•ã„ã€‚';
            resultText.textContent = '---';
            
            if (!SpeechRecognition) {
                // Speech RecognitionãŒåˆ©ç”¨ä¸å¯ã®å ´åˆã®å‡¦ç†
                warningText.innerHTML = 'âŒ Speech Recognition is not available on this browser. Please use Chrome or Edge.';
                statusText.textContent = 'âŒ éŸ³å£°èªè­˜ã¯åˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚Chromeã¾ãŸã¯Edgeã‚’ã”åˆ©ç”¨ãã ã•ã„ã€‚';
                micButton.disabled = true;
                micButton.classList.add('opacity-50', 'cursor-not-allowed');
                return;
            }

            recognition = new SpeechRecognition();
            
            // è‹±ä¼šè©±ç·´ç¿’ã®ãŸã‚ã€è¨€èªã‚’è‹±èªï¼ˆã‚¢ãƒ¡ãƒªã‚«ï¼‰ã«è¨­å®š
            recognition.lang = 'en-US'; 
            recognition.interimResults = false; 
            recognition.continuous = false; // ä¸€å›ç™ºè©±ã”ã¨ã«åœæ­¢

            // **ãƒã‚¤ã‚¯è¨±å¯ã‚’äº‹å‰ã«ç¢ºèªã™ã‚‹é–¢æ•°**
            const startRecording = async () => {
                if (isRecording) {
                    recognition.stop();
                    return;
                }

                try {
                    // åŸ‹ã‚è¾¼ã¿ç’°å¢ƒã§ã®å•é¡Œã‚’å›é¿ã™ã‚‹ãŸã‚ã€navigator.mediaDevices.getUserMedia ã‚’ä½¿ã£ã¦
                    // ãƒã‚¤ã‚¯ã®è¨±å¯ã‚’æ˜ç¤ºçš„ã«è¦æ±‚ã—ã€è¨±å¯ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’å¼·åˆ¶çš„ã«è¡¨ç¤ºã•ã›ã‚‹ã€‚
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    stream.getTracks().forEach(track => track.stop()); // ã‚¹ãƒˆãƒªãƒ¼ãƒ ã¯ã™ãã«åœæ­¢

                    // éŒ²éŸ³é–‹å§‹ã®UIå¤‰æ›´ã¨Web Speech APIã®é–‹å§‹
                    isRecording = true;
                    micButton.classList.add('bg-danger-red', 'recording-pulse');
                    micButton.classList.remove('bg-primary-blue');
                    micIcon.style.stroke = 'white';
                    statusText.textContent = 'ğŸ‘‚ èã„ã¦ã„ã¾ã™... ä»Šè©±ã—ã¦ãã ã•ã„ï¼';
                    micInstruction.textContent = 'ã‚¿ãƒƒãƒ—ã—ã¦çµ‚äº†';
                    resultText.textContent = ''; 
                    scoreArea.classList.add('hidden');
                    
                    recognition.start();

                } catch (e) {
                    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒã‚¤ã‚¯ã‚¢ã‚¯ã‚»ã‚¹ã‚’æ‹’å¦ã—ãŸå ´åˆ
                    console.error("Microphone access failed:", e);
                    isRecording = false; // ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã¯isRecordingã‚’ãƒªã‚»ãƒƒãƒˆ
                    micButton.classList.remove('bg-danger-red', 'recording-pulse');
                    micButton.classList.add('bg-primary-blue');
                    micIcon.style.stroke = 'white';
                    statusText.textContent = 'âŒ ãƒã‚¤ã‚¯ã®åˆ©ç”¨ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚'; 
                    // warningTextã¯HTMLã§é™çš„ã«è¨­å®šã•ã‚Œã¦ã„ã‚‹ã®ã§å¤‰æ›´ã—ãªã„
                }
            };
            
            // éŒ²éŸ³é–‹å§‹æ™‚ã®ã‚¤ãƒ™ãƒ³ãƒˆ 
            recognition.onstart = () => {
                // UIã¯startRecordingã§æ›´æ–°æ¸ˆã¿ã ãŒã€å¿µã®ãŸã‚çŠ¶æ…‹ã‚’ä¿è¨¼
                isRecording = true;
            };

            // èªè­˜çµæœãŒå‡ºãŸæ™‚ã®ã‚¤ãƒ™ãƒ³ãƒˆ 
            recognition.onresult = async (event) => {
                let transcript = event.results[0][0].transcript;
                
                // èªè­˜çµæœã®æ•´å½¢ (å¥èª­ç‚¹ãŒãªã„å ´åˆã€ãƒ”ãƒªã‚ªãƒ‰ã‚’è¿½åŠ )
                if (!/[.!?]$/.test(transcript.trim())) {
                    transcript = transcript.trim() + '.';
                } else {
                    transcript = transcript.trim();
                }

                resultText.textContent = transcript;
                statusText.textContent = 'âœ… èªè­˜ã—ã¾ã—ãŸï¼æ¡ç‚¹ä¸­ã§ã™...';

                try {
                    const scoreData = await checkEnglishAndScore(transcript);
                    displayScore(scoreData);
                    statusText.textContent = 'ğŸ‰ æ¡ç‚¹å®Œäº†ï¼çµæœã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
                } catch (e) {
                    // AIæ¡ç‚¹ã«å¤±æ•—ã—ãŸå ´åˆã®ã‚ˆã‚Šå…·ä½“çš„ãªã‚¨ãƒ©ãƒ¼å‡¦ç†
                    console.error("Scoring failed (API/JSON Error):", e);
                    scoreText.textContent = 'N/A';
                    scoreText.classList.remove('text-success-green', 'text-secondary-yellow', 'text-gray-500');
                    scoreText.classList.add('text-danger-red');
                    
                    // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«APIé–¢é€£ã®ãƒ’ãƒ³ãƒˆã‚’è¿½åŠ 
                    retranslationText.textContent = 'AIã«ã‚ˆã‚‹æ¡ç‚¹å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚'; 
                    feedbackText.textContent = `ã‚µãƒ¼ãƒãƒ¼å¿œç­”ã¾ãŸã¯JSONè§£æã‚¨ãƒ©ãƒ¼ã§ã™ã€‚ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã€ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚ (Error: ${e.message.split('\n')[0]})`;
                    statusText.textContent = 'âŒ æ¡ç‚¹ä¸­ã«é‡å¤§ãªã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚'; 
                }
            };

            // éŒ²éŸ³çµ‚äº†æ™‚ã®ã‚¤ãƒ™ãƒ³ãƒˆ 
            recognition.onend = () => {
                isRecording = false;
                // UIã¯onendã§ãƒªã‚»ãƒƒãƒˆ
                micButton.classList.remove('bg-danger-red', 'recording-pulse');
                micButton.classList.add('bg-primary-blue');
                micIcon.style.stroke = 'white';
                micInstruction.textContent = 'Tap and speak!'; 
                
                // èªè­˜çµæœãŒç©ºã®å ´åˆã€èªè­˜å¤±æ•—ã¨ã—ã¦æ‰±ã†
                if (resultText.textContent === "" || resultText.textContent === "---") {
                    statusText.textContent = 'èã“ãˆã¾ã›ã‚“ã§ã—ãŸã€‚ã‚‚ã†ä¸€åº¦è©±ã—ã¦ã¿ã‚ˆã†ï¼'; 
                    scoreArea.classList.add('hidden');
                    resultText.textContent = '---';
                }
            };

            // ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæ™‚ã®ã‚¤ãƒ™ãƒ³ãƒˆ 
            recognition.onerror = (event) => {
                console.error('Speech Recognition Error:', event.error);
                isRecording = false;
                micButton.classList.remove('bg-danger-red', 'recording-pulse');
                micButton.classList.add('bg-primary-blue');
                micIcon.style.stroke = 'white';
                micInstruction.textContent = 'Tap and speak!'; 
                
                let errorMessage = 'âŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚';
                if (event.error === 'not-allowed' || event.error === 'permission-denied') {
                    errorMessage = 'âŒ ãƒã‚¤ã‚¯ã®åˆ©ç”¨ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚'; 
                } else if (event.error === 'no-speech') {
                    errorMessage = 'éŸ³å£°ãŒæ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚ã¯ã£ãã‚Šè©±ã—ã¦ãã ã•ã„ã€‚'; 
                }
                statusText.textContent = errorMessage;
            };

            // ãƒã‚¤ã‚¯ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ãƒãƒ³ãƒ‰ãƒ©
            micButton.addEventListener('click', startRecording);
        }
        
        // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®åˆæœŸåŒ–
        window.onload = initRecognition;
    </script>
</body>
</html>
